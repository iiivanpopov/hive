name: Copilot PR Summary

on:
  pull_request:
    branches: [main]
    types: [opened]

permissions:
  contents: read
  pull-requests: write

jobs:
  summarize:
    runs-on: ubuntu-latest
    if: github.head_ref == 'development'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Copilot Summary
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const prNumber = context.issue.number;

            // Get commits
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Get files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context. repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Format summary
            const commitMessages = commits.map(c => `- ${c.commit.message}`).join('\n');
            const filesList = files.map(f => `- \`${f.filename}\` (+${f.additions}/-${f.deletions})`).join('\n');

            const summary = `## ðŸ“‹ Copilot PR Summary

            ### Commits (${commits.length}):
            ${commitMessages}

            ### Files Changed (${files.length}):
            ${filesList}

            ### Recommendations:
            - âœ… Review all changes carefully
            - âœ… Ensure tests are passing
            - âœ… Check for breaking changes
            - âœ… Verify documentation is updated

            ---
            *Generated by GitHub Copilot*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: summary
            });
